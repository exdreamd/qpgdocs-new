---
title: 停止程序运行
date: 2024-07-31T22:24:16+08:00
draft: false
---

在 QuecPython 开发过程中，您经常需要停止正在运行的程序。例如，当您修改了代码，需要上传新的代码并重新运行时；当您的程序运行出错，需要停止程序并进行调试时；或者当您的程序占用了大量的系统资源，例如内存、网络连接等，您需要停止程序以释放这些资源时。

本文将详细介绍如何在 QuecPython 中停止程序运行，并提供一些实用的技巧和注意事项，帮助您避免常见的错误，并提升您的开发效率。

## 为什么要停止程序？

在 QuecPython 开发中，您需要使用上位机工具 (例如 QPYcom) 与模块进行交互，例如：

- **文件管理**: 您可能需要在模块的存储器中创建、删除、修改文件，例如配置文件、数据文件、Python 脚本文件等。
- **REPL 交互**: 您可以使用 REPL（Read-Eval-Print Loop，交互式解释器）环境，实时输入 Python 代码并查看执行结果，方便进行代码调试和功能验证。

这些操作都需要上位机工具与模块进行通信，并控制模块执行特定的操作。例如，当您使用 QPYcom 上传文件时，QPYcom 会向模块发送指令，让模块将文件保存到存储器中；当您使用 QPYcom 进行 REPL 交互时，QPYcom 会向模块发送您输入的 Python 代码，并接收模块返回的执行结果。

然而，当模块正在执行您的 Python 脚本时，MicroPython 解释器会专注于脚本的执行，而不会响应来自 REPL 的其他指令，包括 QPYcom 发送的指令。这就好比一个人正在全神贯注地读书，外界的声音他都听不到。

因此，在您需要进行文件管理、REPL 交互等操作时，需要先停止正在运行的程序，这样模块才能响应来自上位机工具的指令。

## 停止程序：快捷键与重启

QuecPython 提供了多种方式来停止正在运行的程序，您可以根据具体情况选择合适的方法。

### 使用快捷键 `Ctrl+C`

在大多数情况下，您可以使用 `Ctrl+C` 快捷键来停止正在运行的 QuecPython 程序。当您按下 `Ctrl+C` 时，QuecPython 解释器会收到一个 `KeyboardInterrupt` 异常信号，这会导致当前正在执行的代码块停止运行，并将控制权返回给 REPL 环境。

**操作方法**:

1. 在 QPYcom 的 REPL 窗口中，按下 `Ctrl` 键并保持不放。
2. 按下 `C` 键，然后松开所有按键。

{{< callout type="info" >}}

**提示**

- **单线程程序**: 如果您的程序不包含多线程，按下 `Ctrl+C` 会立即停止程序的运行，并将控制权返回给 REPL 环境。您将在 REPL 窗口中看到 `>>>` 提示符，表示模块已经准备好接收您的下一条指令。
- **多线程程序**: 如果您的程序包含多线程，按下 `Ctrl+C` 只会停止主线程的运行，而其他线程可能仍在后台运行。这是因为 `Ctrl+C` 信号只会发送给主线程，而其他线程并不会接收到这个信号。

{{< /callout >}}

### 重启 MicroPython 虚拟机

如果您的程序包含多线程，并且 `Ctrl+C` 无法完全停止程序，您可以使用 `Ctrl+A`、`Ctrl+D`、`Ctrl+B` 组合键来重启 MicroPython 虚拟机，从而强制停止所有线程。

- **`Ctrl+A`**: 进入 REPL 环境的 RAW 模式。RAW 模式是一种特殊的 REPL 模式，在这种模式下，所有输入的字符都会被直接发送到模块，而不会被 REPL 环境解析。您可以将 RAW 模式理解为一种“透明传输”模式，它可以让您直接与模块的底层进行通信。
- **`Ctrl+D`**: 发送软件复位信号，重启 MicroPython 虚拟机。这会导致 MicroPython 解释器停止运行，并重新加载 Python 脚本文件。所有正在运行的线程都会被停止，包括主线程和后台线程。**需要注意的是，这并不会重启底层的 RTOS，模块的硬件和基础服务仍然在运行。**
- **`Ctrl+B`**: 退出 RAW 模式，回到 REPL 环境的普通交互模式。

**操作方法**:

1. 在 QPYcom 的 “REPL” 窗口中，按下 `Ctrl` 键并保持不放。
2. 依次按下 `A` 键、 `D` 键、 `B` 键，然后松开所有按键。

### 重启模块或重新烧录固件

如果以上方法都无法停止程序运行，您可以尝试以下两种方法：

- **重启模块**: 如果您的程序没有被命名为 `main.py`，您可以通过断开模块电源或按下开发板上的复位按钮来重启模块。**重启会中断模块的当前运行状态**，包括所有正在执行的程序，并重新初始化 RTOS 和 MicroPython 解释器。
- **重新烧录固件**: 如果您的程序被命名为 `main.py`，重启模块后程序会再次自动运行。在这种情况下，您只能通过重新烧录 QuecPython 固件来彻底停止程序运行。重新烧录固件会擦除模块上的所有数据，包括用户程序和文件，因此请谨慎操作。

## 注意事项：编写可控的代码

- **避免不带延时和跳出条件的死循环**: 在编写代码时，请务必避免出现不带任何跳出条件、也不带任何延时的死循环。这样的死循环会导致程序一直运行，无法响应来自上位机工具的指令，您只能通过重启模块或重新烧录固件来停止程序。此外，死循环可能会导致模块持续占用 CPU 资源，甚至可能触发底层的看门狗复位机制，导致模块意外重启。
- **程序分段**: 对于较长的程序，建议您将其拆分成多个函数或模块，并在每个函数或模块之间添加延时或检查点，以便您能够在需要时停止程序的运行，并进行调试。

## 总结

本文介绍了在 QuecPython 中停止程序运行的几种方法，并提供了一些实用的技巧和注意事项。希望这些信息能够帮助您更好地控制您的 QuecPython 程序，提升您的开发效率。
