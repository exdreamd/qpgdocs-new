---
title: 无线通信模块及开发
date: 2024-07-23T09:22:33+08:00
weight: 24
---

## 初识模块

无线通信模块，简称模块（Module，亦称模组或单元），是实现数据上云和远程通信的必不可少的组件，在各类物联网场景中已经得到了极为广泛的应用。从功能上看，它是在本地设备和网络之间构建连接的桥梁。像电脑插上 USB 网卡就可以开始上网一样，在嵌入式系统中加入了模块，系统就具有了连接无线网络的可能性。

![](/images/device-with-ec20.png "搭载移远 EC20 模块的某物联网产品主板")

很多初次接触模块的用户会对模块这样一个被金属壳笼罩着的奇怪器件感到陌生，它与传统的芯片和分立器件存在很大的不同。实际上，要理解模块，我们需要先了解嵌入式系统和核心板的概念。

### 嵌入式系统

嵌入式系统是一种专用的计算机系统，它被嵌入到更大的系统中，用于执行特定的任务。与我们日常使用的通用计算机系统（如个人电脑、智能手机）不同，嵌入式系统通常资源受限，例如处理能力、内存容量、功耗等方面都受到限制，但它具有专用性强、可靠性高、成本低廉等优势，因此在各个领域得到了广泛的应用。

![](/images/embedded-system-compare.png "个人计算机和嵌入式系统的对比")

#### 嵌入式系统的特点

嵌入式系统的设计目标是满足特定应用的需求，因此它们通常具有以下特点：

- **专用性强**: 嵌入式系统通常面向特定的应用领域，其硬件和软件都被设计用于执行特定的任务。例如，用于控制空调的嵌入式系统与用于控制洗衣机的嵌入式系统，其硬件和软件设计就完全不同。
- **实时性**: 很多嵌入式系统需要对外部事件做出快速响应，例如汽车的 ABS 系统需要在几毫秒内对车轮的抱死情况做出反应。
- **可靠性高**: 嵌入式系统通常需要在恶劣的环境下长期稳定运行，例如工业控制系统、航空航天系统等。
- **资源受限**: 嵌入式系统通常使用低功耗、低成本的处理器和存储器，其资源远不如通用计算机系统丰富。
- **功耗低**: 很多嵌入式系统使用电池供电，因此需要尽可能降低功耗，以延长电池寿命。
- **体积小**: 很多嵌入式系统需要集成到其他设备中，因此需要尽可能减小体积。

#### 嵌入式系统的例子

嵌入式系统广泛应用于我们生活的方方面面，以下列举一些常见的例子：

- **消费电子**: 智能手机、平板电脑、智能手表、智能音箱、数码相机、游戏机等。
- **家用电器**: 智能电视、智能冰箱、智能洗衣机、空调、微波炉、电饭煲等。
- **汽车电子**: 发动机控制单元（ECU）、防抱死系统（ABS）、电子稳定程序（ESP）、车载娱乐系统、导航系统等。
- **工业控制**: 可编程逻辑控制器（PLC）、分布式控制系统（DCS）、数控机床、机器人等。
- **医疗电子**: 心电图仪、B 超机、CT 机、核磁共振仪等。
- **航空航天**: 飞行控制系统、导航系统、通信系统等。

#### 嵌入式系统的结构

##### 处理器

嵌入式系统使用各种类型的处理器，从简单的 8 位单片机到复杂的 64 位多核处理器，具体取决于应用的需求。常见的嵌入式处理器类型包括：

- **MCU（Microcontroller Unit，微控制器，常称单片机）**: MCU 是一种将处理器、内存、I/O 接口等集成到一个芯片上的微型计算机系统，具有体积小、成本低、易于开发等优点，适用于简单的控制应用。
- **MPU（Microprocessor Unit，微处理器）**: MPU 是一种功能更强大的处理器，通常需要外接内存、I/O 接口等芯片才能构成完整的系统，适用于复杂的控制和数据处理应用。
- **DSP（Digital Signal Processor，数字信号处理器）**: DSP 是一种专门用于处理数字信号的处理器，具有高速运算、实时处理的能力，适用于音频处理、图像处理、通信等领域。
- **FPGA（Field Programmable Gate Array，现场可编程门阵列）**: FPGA 是一种可编程的逻辑器件，可以根据需要配置成不同的电路，具有高度的灵活性，适用于需要定制硬件的应用。

近年来，随着半导体技术的进步，SoC（System on a Chip，片上系统）成为了嵌入式系统中应用愈发普遍的一种处理器形式。SoC 将处理器、内存、I/O 接口以及其他功能模块集成到一个芯片上，具有更高的集成度、更低的功耗和更小的体积，为嵌入式系统的进一步小型化和功能扩展提供了可能。基于 SoC 的嵌入式系统在智能手机、平板电脑、智能手表、智能音箱等领域得到了广泛的应用。

![](/images/sdm845-block-diagram.png "高通骁龙 845 SoC 功能框图")

##### 存储器

存储器用于存储程序代码和数据。常见的嵌入式存储器有 ROM、RAM、Flash 等多种类型。在一些不太严谨的场合，它们被统称为内存。

- **ROM (Read-Only Memory，只读存储器)**: ROM 中的数据在出厂时就被固化，不能被修改，通常用于存储程序代码。但实际上，目前很多资料中所说的 ROM 实际上指的是 Flash 存储器，因为它既可以像 ROM 一样在出厂时写入数据，又可以像 RAM 一样在运行时修改数据。
- **RAM (Random Access Memory，随机存取存储器)**: RAM 中的数据可以随时读写，但断电后数据会丢失，通常用于存储程序运行时的数据。
- **Flash**: Flash 是一种非易失性存储器，断电后数据不会丢失，可以反复擦写，但擦写次数有限，通常用于存储程序代码、数据和配置文件。Flash 存储器可以进一步细分为 NOR Flash 和 NAND Flash 两种，它们在读写速度、存储密度、成本等方面有所差异，适用于不同的应用场景。

##### 输入/输出接口

输入/输出接口用于与外部设备进行交互，例如传感器、执行器、显示屏、通信模块等。常见的嵌入式接口有 GPIO、UART、I2C、SPI 等。

- **GPIO (General Purpose Input/Output，通用输入/输出接口)**: GPIO 可以根据需要配置成输入或输出模式，用于控制 LED 灯、读取按钮状态、驱动电机等。
- **UART (Universal Asynchronous Receiver/Transmitter，通用异步收发传输器)**: UART 是一种串行通信接口，用于与其他设备进行异步串行通信，例如与 PC 进行调试、与 GPS 模块通信等。
- **I2C (Inter-Integrated Circuit，集成电路总线)**: I2C 是一种两线制串行通信接口，用于连接各种 I2C 设备，例如 RTC 时钟芯片、EEPROM 存储芯片、温度传感器等。
- **SPI (Serial Peripheral Interface，串行外设接口)**: SPI 是一种高速串行通信接口，用于连接各种 SPI 设备，例如 Flash 存储芯片、ADC 转换器、DAC 转换器等。

##### 操作系统

有些嵌入式系统需要使用操作系统来管理系统的硬件和软件资源，提供各种服务，例如任务调度、内存管理、中断处理、文件系统等。而有些简单的嵌入式系统则可以不使用操作系统，直接运行裸机程序。

- **实时操作系统 (Real-Time Operating System，RTOS)**: RTOS 是一种能够在规定时间内完成特定任务的操作系统，具有实时性强、可预测性高的特点，适用于对实时性要求高的应用，例如工业控制、航空航天等。
- **非实时操作系统**: 非实时操作系统不要求任务必须在规定时间内完成，适用于对实时性要求不高的应用，例如消费电子、网络设备等。

### 核心板（SoM）

为了简化嵌入式系统的开发和生产，人们通常会将处理器、内存、电源管理等核心组件集成到一个小型的电路板上，形成核心板（System on Module，SoM）。核心板可以看作是嵌入式系统的“心脏”，它集成了系统最核心的功能模块，并提供标准化的接口，方便与其他外围电路进行连接。

#### 核心板的定义

核心板是指将处理器、存储器、电源管理等核心组件集成到一起的小型化电路板模块，通常采用 SMT 表面贴装技术进行生产，具有体积小、集成度高、接口标准化等特点。核心板通常需要搭配外围电路才能构成完整的嵌入式系统，例如电源电路、输入/输出接口电路、显示电路、通信电路等。

![](/images/som-stm32mp1.png "一种搭载 STM32MP157 芯片的核心板")

#### 为什么要使用核心板

在嵌入式系统的设计过程中，开发者可以选择使用分立元件自行设计、组装和焊接电路板，也可以选择使用核心板。那么，为什么要使用核心板呢？

- **简化设计**: 核心板集成了处理器、内存、电源管理等核心组件，开发者无需再进行繁琐的硬件设计，可以直接使用核心板提供的接口进行开发，从而简化了设计流程，降低了开发难度。
- **降低成本**: 核心板通常由专业的厂商设计和生产，可以享受规模化生产带来的成本优势。对于开发者而言，使用核心板比自行设计和生产电路板更经济实惠。
- **提高可靠性**: 核心板通常经过了专业的测试和验证，可以保证其高可靠性和稳定性。对于开发者而言，使用核心板可以避免由于硬件设计缺陷或焊接问题导致的系统故障。
- **缩短开发周期**: 使用核心板可以大大缩短嵌入式系统的开发周期，因为开发者可以将更多的精力集中在应用软件的开发上，而无需过多关注底层的硬件设计。
- **提高可维护性**: 核心板采用标准化的接口，方便与其他电路板进行连接，提高了系统的可扩展性和可维护性。如果核心板出现故障，可以方便地进行更换，而无需更换整个系统。

![](/images/som-on-carrier-black.gif "核心板的可替换性")

#### 核心板的应用

核心板被广泛应用于各种嵌入式系统中，例如：

- **智能家居**: 智能家居网关、智能音箱、智能门锁等。例如，小米智能音箱采用了 Amlogic 的 A113X 处理器核心板，该核心板集成了四核 Cortex-A53 处理器、2GB 内存、16GB 存储空间等，为智能音箱提供了强大的性能保障。
- **工业控制**: PLC、DCS、数控系统等。例如，西门子的 S7-1500 系列 PLC 就采用了基于 Infineon TriCore 处理器的核心板，该核心板集成了高性能处理器、大容量内存、丰富的 I/O 接口等，满足了工业控制领域对实时性、可靠性和稳定性的要求。
- **汽车电子**: 车载娱乐系统、ADAS 系统、车身控制系统等。例如，特斯拉的 Model 3 车型采用了基于 NVIDIA Drive PX2 平台的核心板，该核心板集成了高性能 GPU、深度学习加速器等，为自动驾驶功能提供了强大的计算能力。
- **医疗电子**: 医疗仪器、监护仪、移动医疗设备等。
- **物联网**: 智能传感器、智能网关、边缘计算设备等。

### 模块：无线通信领域的“核心板”

理解了嵌入式系统和核心板的概念，我们就可以更好地理解无线通信模块了。实际上，模块本质上也是一种核心板，它将无线通信所需的各种组件集成在一起，提供标准化的接口，方便开发者进行集成和开发。

![](/images/ec20-naked-top.png "某 4G 模块的内部图像")

#### 模块与其他核心板的异同

模块与其他类型的核心板在本质上是相同的，都是将核心功能组件集成到一个小型化的电路板模块中，并提供标准化的接口。但模块又有一些独特之处：

- **专用性更强**: 模块专门用于实现无线通信功能，而其他类型的核心板则可以用于各种不同的应用领域。
- **集成度更高**: 为了实现复杂的无线通信功能，模块通常需要集成更多的组件，例如射频电路、基带电路、天线等，因此模块的集成度通常比其他类型的核心板更高。
- **对可靠性和稳定性要求更高**: 无线通信环境复杂多变，模块需要在各种不同的环境下稳定可靠地工作，因此对模块的可靠性和稳定性要求更高。

#### 模块的组成

![](/images/ec20-inner-components.png "EC20 Mini PCIe 模块的元件组成")

模块的主芯片（Main Chip），也称为基带（Baseband）芯片或调制解调器（Modem）芯片，是整个模块的核心，负责完成复杂的无线通信功能，例如编码、调制、射频信号处理等。常见的蜂窝通信模块主芯片厂商有高通（Qualcomm）、华为海思（HiSilicon）、紫光展锐（UNISOC）等。

模块的主芯片与手机 SoC（尤其是功能机的 SoC）在功能和结构上非常相似。它们都需要集成处理器、内存、基带、射频等功能模块，并运行嵌入式操作系统。从这个意义上看，模块既像一台没有屏幕和电池的手机，又像一种功能较为复杂的单片机。

除了主芯片，模块通常还包含以下组件：

- **存储器**: 用于存储程序代码、数据和配置信息。模块通常会集成 Flash 存储器作为程序存储器，以及 SRAM 或 DRAM 作为运行内存。
- **电源管理芯片**: 为模块提供稳定的电源供应，并提供电压转换、电流保护等功能。
- **功率放大器**: 将射频信号放大，以便于远距离传输。功率放大器的性能指标直接影响到模块的通信距离和信号质量。
- **射频前端**: 完成射频信号的接收和发送，以及信号的滤波和匹配等功能。射频前端的性能指标直接影响到模块的接收灵敏度和抗干扰能力。

随着技术的发展和芯片制造工艺的提升，在现代模块中，主芯片通常已经集成了应用处理器（Application Processor，AP）、存储器、基带和射频的相关功能。这使得模块的结构得到进一步简化，生产成本也得到了进一步降低。

![](/images/qcx216-diagram.png "高通 QCX216 4G Modem 芯片功能框图")

与其他类型的核心板一样，模块也具有高集成度、标准化接口、可扩展性等特点，方便开发者进行集成和开发。开发者可以将模块看作是一个“黑盒子”，只需要了解其提供的接口和功能，就可以快速实现无线通信功能，而无需深入了解复杂的无线通信技术细节。

## 模块的应用模式

对于同一台 Android 手机，不同人有不同的用法。一些用户会安分地使用出厂自带的系统和功能，另一些则热衷于解锁、刷机、root 等操作，更进一步地去开发和挖掘设备的潜力。和手机类似，模块也有这样的两类应用模式：标准模式和二次开发模式。

### 标准模式

和普通手机一样，模块在出厂时通常都会内置操作系统和应用程序。对于许多用户来说，直接使用模块出厂预置功能就可以满足大部分的网络通信需求。这种无需对模块进行开发和调整，直接作为成品功能单元进行使用的方式称为标准模式或传统模式，是当前应用最普遍的模块使用方式。

#### AT 指令简介

![](/images/at-command-architecture.png "AT 指令的运行方式")

提到模块的标准模式，就不得不涉及 AT 指令。AT 指令是目前业界历史最悠久，使用领域最广泛的通讯指令集之一。它构建起了一套用户和模块间的完备的双向通信机制：用户（或 MCU）通过向模块发送 AT 指令，控制模块执行包括联网、通话、定位等在内的各类功能，模块则将执行结果和状态返回给用户。这种“一发一收”的机制和相对单一的处理方式非常适合在资源有限的嵌入式环境中使用。如今，市面上的绝大多数模块在出厂时都内置了 AT Server 程序，可以接收、解析和执行特定的 AT 指令。

#### 标准模式的系统架构

如下图所示，在标准模式中，模块与主控（MCU，如 STM32）之间通过 UART 或 USB 接口相连接，基于 AT 指令进行双向交互。

![](/images/standard-mode-module.png "标准模式示意图")

不难看出，MCU 是整套系统的核心，通信模块是作为 MCU 的一个独立的功能外设（“外挂”）的角色而存在的。系统的主要业务逻辑（用户应用，App）在 MCU 中运行，其他外设（图中的 External Devices）通过 UART、I2C 等接口与 MCU 相连，受 MCU 控制。

对于开发者而言，在基于标准模式使用模块时，主要的开发工作量在于主控中运行的用户 App。其业务代码中需要包含较为复杂的 AT 指令发送和返回值解析功能，例如对 URC（Unsolicited Result Code，非请求结果码）的处理等。URC 是指模块主动向用户发送的，用于指示模块状态变化或事件发生的信息，例如网络连接状态、短信到达通知等，不遵循“一发一收”的机制，因而对于初学者难度较大。

除了 AT 指令功能，模块在标准模式下还可以作为无线网卡使用，例如通过 PPP（点对点协议）拨号的方式为主控或其他上位机提供网络连接服务，使其能够访问互联网。此处不做赘述。

### 二次开发模式

在前文中我们曾提到，模块就像是功能较为复杂的单片机。事实上，模块所搭载的主芯片为了满足无线通信的需要，通常具有较高的性能和较多的资源，同时也配备了包括 GPIO、ADC、I2C 等在内的丰富的外设接口，只不过在标准模式下，这些资源对于用户通常不是直接可用的。如果能够“解锁”这一限制，模块的应用潜力将极大提升，这就需要对模块进行二次开发。

二次开发的本意是在软件本身提供的一些基本功能和接口的基础上，进行组合和扩展，开发出新的功能来满足用户的特殊需求。具体到模块开发上，二次开发模式允许开发者在底层操作系统的基础上调用 API 编写并运行自己的应用，充分调用模块的各种资源，实现更多的可能性。

#### 二次开发模式的系统架构

二次开发最重要的意义在于使模块在一定程度上具备了取代标准模式中的主控的能力，因而这种模式又被称为 OpenCPU 或 OpenMCU（不同厂家可能有不同的专门称呼，如移远称之为 QuecOpen）。

![](/images/open-mode-module.png "二次开发模式示意图")

如上图所示，与标准模式相比，OpenCPU 模式由于将模块本身作为主控使用，用户应用（App）直接置于模块内部运行，外设（图中的 External Devices）与模块直接相连，整个系统中无需外部处理器（MCU）或只需简单的外部芯片（图中的 Simple Microchip），因而可以有效地达到精简硬件设计、降低器件成本、缩小产品尺寸的目的。在单片机价格居高不下的当下，OpenCPU 方案受到了众多公司的青睐。

但是，OpenCPU 方案也具有较为明显的局限性。由于这一模式通常需要用户直接在模块底层运行的操作系统的基础上进行开发，技术门槛较高，传统的、不具备系统级开发经验的单片机开发者很难适应。其次，由于 OpenCPU 技术支持难度大，模块厂家通常只向大客户提供相关的工具和资料，入门较为不便。最后，不同厂家、不同型号的模块，其 OpenCPU 开发环境和开发工具存在较大差别，用户编写的程序在不同模块间的移植存在一定的难度。

### 使用脚本语言开发模块

传统的 OpenCPU 开发通常使用 C 语言，因此也被称作 CSDK 开发。用户需要直接修改和控制底层的操作系统，具有较高的难度和一定的风险性。在之前的文章中，我们介绍了低代码开发方式和它在物联网领域的应用。目前，已经有部分模块厂商通过在 CSDK 的基础上移植解释器 / 虚拟机的方式，使得用户可以使用 Lua、Python 等脚本语言对模块进行二次开发。

与 C 语言相比，脚本语言在语法和使用方式上普遍较为简单，开发者无需花费太多时间和精力即可掌握，并可相对轻松地实现业务逻辑，便于项目的快速开发和功能迭代。同时，对于低代码开发方式而言，开发者通常无需考虑内存回收、基础任务调度等底层细节，显著降低了模块二次开发的技术门槛。最后，对于不同型号的模块，只要它们运行的是同一种脚本语言解释器，用户编写的程序通常只需少量修改（甚至无需修改）即可完成移植。

如下的示例分别是在移远 EC100Y-CN 模块上使用 C 语言和 Python 语言实现 LED 闪灯的代码。可以看出，脚本语言更加简单直观，易于编写、便于理解。

{{< tabs items="使用 QuecOpen (CSDK), 使用 QuecPython" >}}

{{< tab >}}

```c {linenos=table}
#include "ql_application.h"
#include "ql_gpio.h"
#include <stdio.h>

static quec_gpio_cfg_t led_gpio_cfg[] =
{
  {GPIO_PIN_NO_75, PIN_DIRECTION_OUT, PIN_NO_EDGE, PIN_PULL_DISABLE, PIN_LEVEL_LOW}
};

static void led_test(void *argv)
{
  ql_gpio_init(led_gpio_cfg[0].gpio_pin_num, led_gpio_cfg[0].pin_dir, led_gpio_cfg[0].pin_pull, led_gpio_cfg[0].pin_level);

  while (1)
  {
      ql_gpio_set_level(led_gpio_cfg[0].gpio_pin_num, PIN_LEVEL_LOW);
      ql_rtos_task_sleep_s(1);
      ql_gpio_set_level(led_gpio_cfg[0].gpio_pin_num, PIN_LEVEL_HIGH);
      ql_rtos_task_sleep_s(1);
  }
}

application_init(led_test, "led_test", 2, 2);
```

{{< /tab >}}

{{< tab >}}

```python {linenos=table}
from machine import Pin
import utime as time

led = Pin(Pin.GPIO15, Pin.OUT, Pin.PULL_DISABLE, 0)

def led_test():
    while 1:
        led.write(0)
        time.sleep(1)
        led.write(1)
        time.sleep(1)

if __name__ == "__main__":
    led_test()
```

{{< /tab >}}

{{< /tabs >}}

当然，由于使用脚本语言开发时屏蔽了很多底层细节，因而在灵活性和可控性上不如传统的 C 语言开发。此外，脚本语言与 C 语言相比，本身性能相对较差、执行速度较慢，因而在部分对于性能和实时性要求较高的场景下不适合使用。

## 选择合适的开发方式

下表比较了标准模式，CSDK 二次开发和脚本二次开发在多个维度的差异。用户可根据实际需求选择最适合自己的开发方式。

|   特性   | 标准模式 | 二次开发（CSDK） | 二次开发（脚本语言） | 备注                                                                                                                                                                                                                                        |
| :------: | :------: | :--------------: | :------------------: | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| 物料成本 |   ⭐⭐   |        ⭐        |          ⭐          | <ul> <li> 二次开发时，可将模块作为系统主控使用，节省单片机部分的成本。</li> </ul>                                                                                                                                                           |
| 上手门槛 |    ⭐    |      ⭐⭐⭐      |          ⭐          | <ul> <li> 模块厂商通常只面向大客户提供 CSDK 开发资料、技术支持和其他相关服务。</li> </ul>                                                                                                                                                   |
| 开发难度 |    ⭐    |      ⭐⭐⭐      |          ⭐          | <ul> <li> CSDK 开发需要开发者拥有 RTOS 或 Linux 开发经验，普通单片机开发者很难快速掌握。</li> <li> 标准模式仅需用户掌握单片机串口通信和字符串处理方法，无特殊要求。</li> <li> 脚本语言开发方式仅需用户掌握基础语法，无特殊要求。</li> </ul> |
| 开发周期 |    ⭐    |      ⭐⭐⭐      |          ⭐          | <ul> <li> CSDK 开发的复杂度决定了其较长的开发周期和较高的开发成本。</li> </ul>                                                                                                                                                              |
| 维护成本 |   ⭐⭐   |      ⭐⭐⭐      |          ⭐          | <ul> <li> 脚本语言的模块化开发的特性有助于保证其长期运行的稳定性，同时普遍内置了 OTA (Over-the-Air，空中下载) 功能，便于执行远程升级。</li> </ul>                                                                                           |
|  灵活性  |    ⭐    |      ⭐⭐⭐      |         ⭐⭐         | <ul> <li> 标准模式下，开发者通常只能调用串口、ADC 等有限的功能。</li> <li> 使用脚本语言开发时，开发者可以通过内置的功能库调用大部分的模块资源。</li> <li> 使用 CSDK 开发时，开发者可以根据自身需求和想法直接控制所有可用资源。</li> </ul>   |
|   性能   |    -     |      ⭐⭐⭐      |         ⭐⭐         | <ul> <li> 脚本语言的性能远低于 C 语言，因此在对于运行速度、时间精度（时序）、资源数量等要求较高的少部分场合，不建议采用脚本语言开发。</li> </ul>                                                                                            |
|   功耗   |    ⭐    |       ⭐⭐       |         ⭐⭐         | <ul> <li> 一般的 4G 模块在自主休眠时的功耗水平在 mA 级别。</li> <li> 在标准模式下，可以通过使用系统主控切断模块供电的方式实现最大限度的省电，最低功耗可达前者的 1/10。</li> </ul>                                                           |
| 生态系统 |  ⭐⭐⭐  |        ⭐        |        ⭐⭐⭐        | <ul> <li> 标准 AT 指令开发和脚本开发在网络上都具有较多的公开资料和教程。</li> <li> CSDK 开发通常不具备开放生态。</li> </ul>                                                                                                                 |
